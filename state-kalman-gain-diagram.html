<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State-space Kalman Gain Diagram</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <script src="js/draggable-number.js"></script>
    <script src="js/gaussian-functions.js"></script>
    <script src="js/formula-elements.js"></script>
    <script src="js/mouse-effects-manager.js"></script>
    <script>
        const mouseEffectsManager = new MouseEffectsManager([...Object.values(variables)]);
    </script>
    <script>
        MathJax = {
            //Enable macros \class, \cssId, \href, \style
            loader: {load: ['[tex]/html']}, 
            tex: {packages: {'[+]': ['html']}},
            // save custom TexMacros in the MathJax configuration object 
            // (becomes MathJax.config.TexMacros after MathJax is loaded)
            TexMacros: {
                wikipedia: `
                \\def\\state{\\class{state}{\\mathbf{x}}}
                \\def\\stateTransition{\\class{state-transition}{\\mathbf{F}}}
                \\def\\controlInput{\\class{control-input}{\\mathbf{u}}}
                \\def\\measurement{\\class{measurement}{\\mathbf{z}}}
                \\def\\measurementNoiseCovariance{\\class{measurement-noise-covariance}{\\mathbf{R}}}
                \\def\\measurementMatrix{\\class{measurement-matrix}{\\mathbf{H}}}
                \\def\\stateCovariance{\\class{state-covariance}{\\mathbf{P}}}
                \\def\\processNoiseCovariance{\\class{process-noise-covariance}{\\mathbf{Q}}}
                \\def\\controlMatrix{\\class{control-matrix}{\\mathbf{B}}}
                \\def\\kalmanGain{\\class{kalman-gain}{\\mathbf{K}}}
                \\def\\varianceRatio{\\class{variance-ratio}{\\widetilde{\\mathbf{K}}_{z}}}
                \\def\\varianceRatioState{\\class{variance-ratio-state}{\\widetilde{\\mathbf{K}}_{x}}}
                \\def\\discreteTime{n}
                `,
                kalmanfilterdotnet: `
                \\def\\state{\\class{state}{\\mathbf{s}}}
                \\def\\stateTransition{\\class{state-transition}{\\mathbf{A}}}
                \\def\\controlInput{\\class{control-input}{\\mathbf{u}}}
                \\def\\measurement{\\class{measurement}{\\mathbf{z}}}
                \\def\\measurementNoiseCovariance{\\class{measurement-noise-covariance}{\\mathbf{R}}}
                \\def\\measurementMatrix{\\class{measurement-matrix}{\\mathbf{C}}}
                \\def\\stateCovariance{\\class{state-covariance}{\\mathbf{P}}}
                \\def\\processNoiseCovariance{\\class{process-noise-covariance}{\\mathbf{Q}}}
                \\def\\controlMatrix{\\class{control-matrix}{\\mathbf{B}}}
                \\def\\kalmanGain{\\class{kalman-gain}{\\mathbf{K}}}
                \\def\\varianceRatio{\\class{variance-ratio}{\\widetilde{\\mathbf{K}}_{z}}}
                \\def\\varianceRatioState{\\class{variance-ratio-state}{\\widetilde{\\mathbf{K}}_{x}}}
                \\def\\discreteTime{t}
                `
            },
          // Custom function to get the desired set of macros,
          // then have the renderer to go back to the compile step so the new macros get used.
          setMacros(name) {
            if (!MathJax.config.TexMacros.hasOwnProperty(name)) {
              console.warn(`TexMacros for "${name}" not found.`);
              return Promise.resolve();
            }
            
            return MathJax.startup.promise = MathJax.startup.promise.then(() => {
              const {mathjax} = MathJax._.mathjax;
              const {STATE} = MathJax._.core.MathItem;
              MathJax.tex2mml(MathJax.config.TexMacros[name]);
              mathjax.handleRetriesFor(() => MathJax.startup.document.rerender(STATE.COMPILED));
              
              mouseEffectsManager.initialize();
            });
          },
          startup: {
            typeset: false, //disable the initial typesetting pass since setMacros() will do typesetting
            ready() {
              MathJax.startup.defaultReady();
              MathJax.config.setMacros('wikipedia');
              const dropdown = document.getElementById('naming-convention-dropdown');
              dropdown.addEventListener('input', (event) => MathJax.config.setMacros(event.target.value));
            }
          }
        }
    </script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        .matrix-table {
            position: relative;
        }
        /* Rectangular pseudo-element before and after the table */
        .matrix-table::before,
        .matrix-table::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px; 
        }
        /* Make the left pseudo-element look like a bracket */
        .matrix-table::before {
            left: 0px;
            border-left: 2px solid black;
            border-top: 2px solid black;
            border-bottom: 2px solid black;
        }
        /* Make the right pseudo-element look like a bracket */
        .matrix-table::after {
            right: 0px;
            border-right: 2px solid black;
            border-top: 2px solid black;
            border-bottom: 2px solid black;
        }
        .matrix-table td {
            text-align: center;
            vertical-align: middle;
            width: 6ch; /* matches the DraggableNumber width */
        }
        .matrix-table tr {
            line-height: 1.5;
        }

        .math-diagram-structure-table {
            border-collapse: collapse;
            margin-left: auto;
            margin-right: auto;
        }

        .math-diagram-structure-table td {
            text-align: center;
            vertical-align: middle;
        }

        .kalman-gain-state-space {
            background-color: rgb(187, 187, 187);
        }

        .kalman-gain-intermediate-space {
            background-color: #dddddd;
        }

        .kalman-gain-measurement-space {
            background-color: rgb(255, 252, 238);
        }

        .kalman-gain-Hstate-gaussian {
            border: 2px solid rgb(0, 0, 255);
            border-radius: 10px;
        }

        .kalman-gain-measurement-gaussian {
            border: 2px solid rgb(0, 150, 0);
            border-radius: 10px;
        }

        .kalman-gain-combined-gaussian {
            border: 2px solid rgb(240, 0, 0);
            border-radius: 10px;
        }

        #state-kalman-gain-plot {
            width: max-content;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        /* Outline the table temporarily so I can see what I'm doing */

        /* .math-diagram-structure-table {
            border: 1px solid #ddd;
        } */

        /* .math-diagram-structure-table td {
            border: 1px solid #ddd;
        }

        .math-diagram-structure-table tr:nth-child(even) {
            background-color: #f2f2f2;
        } */

    </style>
</head>
<body>
    <select id="naming-convention-dropdown">
        <option value="wikipedia">Wikipedia</option>
        <option value="kalmanfilterdotnet">kalmanfilter.net</option>
    </select>

    <table id='kalman-gain-diagram-table' class="math-diagram-structure-table">
        <tr class="kalman-gain-state-space">
            <td>
                <table class="math-diagram-structure-table">
                    <tr>
                        <td>\( \mathcal{N} \left( 
                            \begin{eqnarray}
                            \\
                            \state_{\discreteTime - 1} \\
                            \\
                        \end{eqnarray}
                        \right. =\)
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <draggable-number id="xkalman-gain-old-state-0" min="-3" max="3" step="0.01" value="1">1.0</draggable-number>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <draggable-number id="xkalman-gain-old-state-1" min="-3" max="3" step="0.01" value="0">0.0</draggable-number>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>, \( \stateCovariance_{\discreteTime-1} = \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <draggable-number id="xkalman-gain-old-state-covariance-00" min="0" max="4" step="0.01" value="0.5">0.5</draggable-number>
                                    </td>
                                    <td>
                                        <draggable-number id="xkalman-gain-old-state-covariance-01" min="-3" max="3" step="0.01" value="0.0">0.0</draggable-number>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-covariance-10">0.0</div>
                                    </td>
                                    <td>
                                        <draggable-number id="xkalman-gain-old-state-covariance-11" min="0" max="4" step="0.01" value="0.5">0.5</draggable-number>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>\( \left. 
                                \begin{eqnarray}
                                \\
                                \\
                                \\
                            \end{eqnarray}
                            \right) \)

                    </tr>
                </table>
            </td>
            <td></td>
        </tr>
        <tr class="kalman-gain-intermediate-space">
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
            <td></td>
        </tr>
        <tr class="kalman-gain-intermediate-space">
            <td>
                <table  class="math-diagram-structure-table">
                    <tr>
                        Convert to Measurement Space with
                    </tr>
                    <tr >
                        <td>
                            \( \measurementMatrix = \)
                        </td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div id="xkalman-gain-measurement-matrix-00">1.0</div>
                                    </td>
                                    <td>
                                        <div id="xkalman-gain-measurement-matrix-01">0.0</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
            <td></td>
        </tr>
        <tr class="kalman-gain-intermediate-space">
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
            <td></td>
        </tr>
        <tr class="kalman-gain-measurement-space">
            <td>
                <table class="math-diagram-structure-table">
                    <td>
                        \(\mathcal{N} \left( \measurementMatrix \state_{\discreteTime-1} = 
                        \begin{eqnarray}
                        \\
                        \\
                        \end{eqnarray}\right.
                        \)
                    </td>
                    <td>
                        <table class="matrix-table">
                            <tr>
                                <td>
                                    <div class="dynamic-number-container" id="xkalman-gain-state-measurement-space-0">1.0</div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        , \( \measurementMatrix \stateCovariance \measurementMatrix^T = \)
                    </td>
                    <td>
                        <table class="matrix-table">
                            <tr>
                                <td>
                                    <div class="dynamic-number-container" id="xkalman-gain-state-measurement-space-covariance-00">1.0</div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        \( \left.
                        \begin{eqnarray}
                        \\
                        \\
                        \end{eqnarray}
                        \right) \)
                    </td>
                </table>
            </td>
            <td>
                <table class="math-diagram-structure-table">
                    <tr>
                        <td>\( \mathcal{N} \left( \measurement = 
                            \begin{eqnarray}
                            \\
                            \\
                            \end{eqnarray}\right. \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <draggable-number id="xkalman-gain-measurement-0" min="-3" max="3" step="0.01" value="-1">-1.0</draggable-number>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>, \( \measurementNoiseCovariance = \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <draggable-number id="xkalman-gain-measurement-covariance-00" min="0" max="3" step="0.01" value="0.3">0.3</draggable-number>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>\( \left.
                            \begin{eqnarray}
                            \\
                            \\
                            \end{eqnarray}
                            \right) \)</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="kalman-gain-measurement-space">
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
        </tr>
        <tr class="kalman-gain-intermediate-space"
            style="border-top: 2px dashed black; border-right: 2px dashed black; border-left: 2px dashed black;">
            <td colspan="2">
                Convert to state space with \( \measurementMatrix^{-1} \)
            </td>
        </tr>
        <tr class="kalman-gain-state-space"
            style="border-right: 2px dashed black; border-left: 2px dashed black;">
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
            <td style="font-size: 24px;">&#x2193;</td> <!-- Down arrow -->
        </tr>
        <tr class="kalman-gain-state-space"
            style="border-right: 2px dashed black; border-left: 2px dashed black;">
            <td>
                <table class="math-diagram-structure-table kalman-gain-Hstate-gaussian">
                    <tr>
                        <td>\( \mathcal{N} \left( 
                            \begin{eqnarray}
                            \\
                            \state_{\discreteTime - 1} \\
                            \\
                        \end{eqnarray}
                        \right. =\)
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-d-0">0.0</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-d-1">0.0</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>, \( \stateCovariance_{\discreteTime-1} = \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-covariance-d-00">0.0</div>
                                    </td>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-covariance-d-01">0.0</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-covariance-d-10">0.0</div>
                                    </td>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-old-state-covariance-d-11">0.0</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>\( \left. 
                                \begin{eqnarray}
                                \\
                                \\
                                \\
                            \end{eqnarray}
                            \right) \)

                    </tr>
                </table>
            </td>
            <td>
                <table class="kalman-gain-measurement-gaussian math-diagram-structure-table">
                    <tr>
                        <td>\( \mathcal{N} \left( \measurementMatrix^{-1} \measurement = 
                            \begin{eqnarray}
                            \\
                            \\
                            \\
                            \end{eqnarray}\right. \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-Hz-0">0.0</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>-</td>
                                </tr>
                            </table>
                        </td>
                        <td>, \( \measurementMatrix^{-1} \measurementNoiseCovariance \left( \measurementMatrix^{-1} \right)^T = \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-HRH-00">0.0</div>
                                    </td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            </table>
                        </td>
                        <td>\( \left.
                            \begin{eqnarray}
                            \\
                            \\
                            \\
                            \end{eqnarray}
                            \right) \)</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="kalman-gain-state-space"
            style="border-right: 2px dashed black; border-left: 2px dashed black;">
            <td colspan="2">
                <table class="math-diagram-structure-table">
                    <tr>
                        <td>
                            <table class="math-diagram-structure-table">
                                <tr>
                                    <td>
                                        \( \varianceRatioState 
                                              = \frac{\stateCovariance}{\stateCovariance + \measurementMatrix^{-1} \measurementNoiseCovariance (\measurementMatrix^{-1})^T} 
                                              = \stateCovariance \measurementMatrix^T \left[ \measurementMatrix \stateCovariance \measurementMatrix^T + \measurementNoiseCovariance \right]^{-1} \measurementMatrix =
                                        \)
                                    </td>
                                    <td>
                                        <table class="matrix-table">
                                            <tr>
                                                <td>
                                                    <div class="dynamic-number-container" id="kalman-gain-variance-ratio-00">1.0</div>
                                                </td>
                                                <td>
                                                    <div class="dynamic-number-container" id="kalman-gain-variance-ratio-01">1.0</div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="dynamic-number-container" id="kalman-gain-variance-ratio-10">1.0</div>
                                                </td>
                                                <td>
                                                    <div class="dynamic-number-container" id="kalman-gain-variance-ratio-11">1.0</div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table class="math-diagram-structure-table kalman-gain-combined-gaussian">
                                <tr>
                                    <td>
                                        \( \mathcal{N} \left( (I - \varianceRatioState) \state + \varianceRatioState \measurementMatrix^{-1} \measurement
                                        \text{, } \space \space \space 
                                        (I-\varianceRatioState) \stateCovariance (I-\varianceRatioState)^T + (\varianceRatioState \measurementMatrix^{-1}) \measurementNoiseCovariance (\varianceRatioState \measurementMatrix^{-1})^T \right) \)
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="kalman-gain-state-space"
            style="border-bottom: 2px dashed black; border-right: 2px dashed black; border-left: 2px dashed black;">
            <td colspan="2">
                <div id="state-kalman-gain-plot"></div>
            </td>
        </tr>

        <tr class="kalman-gain-state-space">
            <td colspan="2">
                <table class="math-diagram-structure-table kalman-gain-combined-gaussian">
                    <tr>
                        <td>\(\text{New State Estimate: } \mathcal{N} \left( 
                            \begin{eqnarray}
                            \\
                            \state_{\discreteTime} \\
                            \\
                        \end{eqnarray}
                        \right. =\)
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-0">1.0</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-1">1.0</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>, \( \stateCovariance_{\discreteTime} = \)</td>
                        <td>
                            <table class="matrix-table">
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-covariance-00">1.0</div>
                                    </td>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-covariance-01">0.0</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-covariance-10">0.0</div>
                                    </td>
                                    <td>
                                        <div class="dynamic-number-container" id="xkalman-gain-new-state-covariance-11">1.0</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>\( \left. 
                                \begin{eqnarray}
                                \\
                                \\
                                \\
                            \end{eqnarray}
                            \right) \)
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <script>
        //// Make variables for the elements on the page
        // Draggable Elements
        const xtm1_0 = document.getElementById("xkalman-gain-old-state-0");
        const xtm1_1 = document.getElementById("xkalman-gain-old-state-1");
        const Ptm1_00 = document.getElementById("xkalman-gain-old-state-covariance-00");
        const Ptm1_01 = document.getElementById("xkalman-gain-old-state-covariance-01");
        const Ptm1_11 = document.getElementById("xkalman-gain-old-state-covariance-11");
        const z_0 = document.getElementById("xkalman-gain-measurement-0");
        const R_00 = document.getElementById("xkalman-gain-measurement-covariance-00");
        
        // Not Draggable, but still dynamic elements
        const Ptm1_10 = document.getElementById("xkalman-gain-old-state-covariance-10");
        const Hx_0 = document.getElementById("xkalman-gain-state-measurement-space-0");
        const HPH_00 = document.getElementById("xkalman-gain-state-measurement-space-covariance-00");
        const VR_00 = document.getElementById("kalman-gain-variance-ratio-00");
        const VR_01 = document.getElementById("kalman-gain-variance-ratio-01");
        const VR_10 = document.getElementById("kalman-gain-variance-ratio-10");
        const VR_11 = document.getElementById("kalman-gain-variance-ratio-11");
        const xt_0 = document.getElementById("xkalman-gain-new-state-0");
        const xt_1 = document.getElementById("xkalman-gain-new-state-1");
        const P_00 = document.getElementById("xkalman-gain-new-state-covariance-00");
        const P_01 = document.getElementById("xkalman-gain-new-state-covariance-01");
        const P_10 = document.getElementById("xkalman-gain-new-state-covariance-10");
        const P_11 = document.getElementById("xkalman-gain-new-state-covariance-11");
        const xtm1_0_d = document.getElementById("xkalman-gain-old-state-d-0");
        const xtm1_1_d = document.getElementById("xkalman-gain-old-state-d-1");
        const Ptm1_00_d = document.getElementById("xkalman-gain-old-state-covariance-d-00");
        const Ptm1_01_d = document.getElementById("xkalman-gain-old-state-covariance-d-01");
        const Ptm1_10_d = document.getElementById("xkalman-gain-old-state-covariance-d-10");
        const Ptm1_11_d = document.getElementById("xkalman-gain-old-state-covariance-d-11");
        const Hz_0 = document.getElementById("xkalman-gain-Hz-0");
        const HRH_00 = document.getElementById("xkalman-gain-HRH-00");

        // constants
        const H_00 = parseFloat(document.getElementById("xkalman-gain-measurement-matrix-00").textContent);
        const H_01 = parseFloat(document.getElementById("xkalman-gain-measurement-matrix-01").textContent);
        
        //// Make the old state covariance be positive semi-definite and symmetric
        Ptm1_00.setValidityCondition((newValue) => {
            return isPositiveSemiDefinite([[newValue, Ptm1_01.value], [Ptm1_01.value, Ptm1_11.value]])
        });
        Ptm1_01.setValidityCondition((newValue) => {
            return isPositiveSemiDefinite([[Ptm1_00.value, newValue], [newValue, Ptm1_11.value]])
        });
        Ptm1_11.setValidityCondition((newValue) => {
            return isPositiveSemiDefinite([[Ptm1_00.value, Ptm1_01.value], [Ptm1_01.value, newValue]])
        });


        //// Update the matrices whenever one is changed
        function updateKalmanGainDiagramX() {
            // Note: Ptm1_01 is always used instead of Ptm1_10 because the matrix is symmetric
            const _Hx_0 = H_00 * xtm1_0.value + H_01 * xtm1_1.value;
            const _HPH_00 = H_00 * (Ptm1_00.value * H_00 + Ptm1_01.value * H_01) + H_01 * (Ptm1_01.value * H_00 + Ptm1_11.value * H_01);
            
            // Use the kalman gain formula (same as in measurement space) to update x since can't do H^{-1}
            // K = P_{t|t-1} H^T (H P_{t|t-1} H^T + R)^{-1}
            // x_{t|t} = x_{t|t-1} + K (z - H x_{t|t-1})
            // P_{t|t} = (I - K H) P_{t|t-1}
            const K_denominator = _HPH_00 + R_00.value;
            let K_00 = 0;
            let K_10 = 0;
            if (K_denominator !== 0) {
                K_00 = (Ptm1_00.value * H_00 + Ptm1_01.value * H_01) / K_denominator;
                K_10 = (Ptm1_01.value * H_00 + Ptm1_11.value * H_01) / K_denominator;
            }
            const _xt_0 = xtm1_0.value + K_00 * (z_0.value - _Hx_0);
            const _xt_1 = xtm1_1.value + K_10 * (z_0.value - _Hx_0);
            const _P_00 = Ptm1_00.value - K_00 * (Ptm1_00.value * H_00 + Ptm1_01.value * H_01);
            const _P_01 = Ptm1_01.value - K_00 * (Ptm1_01.value * H_00 + Ptm1_11.value * H_01);
            const _P_10 = Ptm1_01.value - K_10 * (Ptm1_00.value * H_00 + Ptm1_11.value * H_01);
            const _P_11 = Ptm1_11.value - K_10 * (Ptm1_01.value * H_00 + Ptm1_11.value * H_01);

            // Find the Variance Ratio
            // Assuming H[1] is 0, then H^T H = [[H[0]*H[0],0],[0,0]]
            // Also, R and HPH^T are scalars, so can just divide
            let _VR_00 = Ptm1_00.value;
            let _VR_10 = Ptm1_01.value;
            let _VR_01 = Ptm1_01.value;
            let _VR_11 = Ptm1_11.value;
            if (K_denominator !== 0) {
                const HT_HPHT_R_H_00 = H_00*H_00/ K_denominator;
                _VR_00 *= HT_HPHT_R_H_00;
                _VR_10 *= HT_HPHT_R_H_00;
                _VR_01 *= HT_HPHT_R_H_00;
                _VR_11 *= HT_HPHT_R_H_00;
            }
            // TODO: Handle the case where both covariances are 0


            VR_00.textContent = _VR_00.toFixed(2);
            VR_10.textContent = _VR_10.toFixed(2);
            VR_01.textContent = _VR_01.toFixed(2);
            VR_11.textContent = _VR_11.toFixed(2);
            Hx_0.textContent = _Hx_0.toFixed(2);
            HPH_00.textContent = _HPH_00.toFixed(2);
            xt_0.textContent = _xt_0.toFixed(2);
            xt_1.textContent = _xt_1.toFixed(2);
            P_00.textContent = _P_00.toFixed(2);
            P_01.textContent = _P_01.toFixed(2);
            P_10.textContent = _P_10.toFixed(2);
            P_11.textContent = _P_11.toFixed(2);
            Ptm1_10.textContent = Ptm1_01.value.toFixed(2);
            
            let _Hz_0 = 0;
            let _HRH_00 = 0;
            if (H_00 !== 0) {
                _Hz_0 = z_0.value / H_00;
                Hz_0.textContent = _Hz_0.toFixed(2);
                _HRH_00 = R_00.value / H_00 / H_00;
                HRH_00.textContent = _HRH_00.toFixed(2);
            }
            else {
                Hz_0.textContent = "-";
                HRH_00.textContent = "-";
            }
            xtm1_0_d.textContent = xtm1_0.value.toFixed(2);
            xtm1_1_d.textContent = xtm1_1.value.toFixed(2);
            Ptm1_00_d.textContent = Ptm1_00.value.toFixed(2);
            Ptm1_01_d.textContent = Ptm1_01.value.toFixed(2);
            Ptm1_10_d.textContent = Ptm1_01.value.toFixed(2);
            Ptm1_11_d.textContent = Ptm1_11.value.toFixed(2);

            const x_tm1_mean = [xtm1_0.value, xtm1_1.value];
            const x_tm1_var = [[Ptm1_00.value, Ptm1_01.value], [Ptm1_01.value, Ptm1_11.value]];
            const x_t_mean = [_xt_0, _xt_1];
            const x_t_var = [[_P_00, _P_01], [_P_10, _P_11]];
            updateKalmanGainPlotX(x_tm1_mean, x_tm1_var, _Hz_0, _HRH_00, x_t_mean, x_t_var);
        }

        //// Generate a plot of the three univariate gausians: Hx_{t-1}, z, and Hx_{t}

        function updateKalmanGainPlotX(x_tm1_mean, 
                                    x_tm1_var,
                                    Hz_mean,
                                    Hz_var,
                                    x_t_mean,
                                    x_t_var) {
            let trace_xtm1 = generateGaussianEllipticalContours(x_tm1_mean, x_tm1_var, color='blue', name='Previous State');
            let trace_Hz = generateGaussianLinearContours(Hz_mean, Hz_var, color='green', name='Measurement');
            let trace_x_t = generateGaussianEllipticalContours(x_t_mean, x_t_var, color='red', name='Combination');

            let traces = trace_xtm1.concat(trace_Hz).concat(trace_x_t);
            
            const layout = {
                title: 'Kalman Gain Probability Density Contours(State Space)',
                legend: {
                    orientation: 'h',
                    yanchor: 'top',
                    xanchor: 'center',
                    y: 1.05,
                    x: 0.5,
                },
                yaxis: {
                    title: 'Velocity',
                    range: [-2, 2]
                },
                xaxis: {
                    title: 'Position',
                    range: [-3, 3]
                },
                margin: {
                    l: 40,
                    r: 40,
                    t: 50,
                    b: 40,
                },
                hovermode: 'closest',
            };
            
            Plotly.react('state-kalman-gain-plot', traces, layout);
        }
        updateKalmanGainDiagramX();

        // Add event listeners to all the draggable elements
        [xtm1_0, xtm1_1, Ptm1_00, Ptm1_01, Ptm1_11, z_0, R_00].forEach(el => el.addEventListener("input", () => {
            updateKalmanGainDiagramX();
        }));
    </script>
</body>

    
