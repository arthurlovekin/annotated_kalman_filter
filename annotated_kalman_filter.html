<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Annotated Kalman Filter</title>

    <!-- put window.MathJax script before importing the rest of MathJax 
     https://docs.mathjax.org/en/latest/web/configuration.html describes async vs defer for loading
     https://docs.mathjax.org/en/latest/web/configuration.html#performing-actions-after-typesetting 
     describes how to perform actions after typesetting-->
    <script>
        window.MathJax = {
            //Enable macros \class, \cssId, \href, \style
            loader: {load: ['[tex]/html']}, 
            tex: {packages: {'[+]': ['html']}},
        };
    </script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

</head>
<body>
    <select id="naming-convention">
        <option value="alt0">Alt0</option>
        <option value="alt1">Alt1</option>
    </select>

    <table id="variable-description-table">
        <thead>
            <tr>
                <th>Variable</th>
                <th>Name</th>
                <th>Description</th>
                <th>Example</th>
            </tr>
        </thead>
        <tbody id="variable-description-table-body">
            <tr id="state-model-row">
                <td id="state"></td>
                <td id="state-model-name"></td>
                <td id="state-model-description"></td>
                <td id="state-model-example"></td>
            </tr>
            <tr id="state-transition-matrix-row">
                <td id="state-transition-matrix"></td>
                <td id="state-transition-matrix-name"></td>
                <td id="state-transition-matrix-description"></td>
                <td id="state-transition-matrix-example"></td>
            </tr>
            <tr id="state-covariance-row">
                <td id="state-covariance"></td>
                <td id="state-covariance-name"></td>
                <td id="state-covariance-description"></td>
                <td id="state-covariance-example"></td>
            </tr>
        </tbody>
    </table>

    <p id="state-model"></p>
    <!-- <p id="measurement-model"></p> -->

    <script>
        class FormulaElement {
            constructor(div_name,
                        display_name, 
                        description, 
                        example, 
                        naming_convention) {
                this.div_name = div_name; // eg. state-model
                this.display_name = display_name; // eg. State Model Equation
                this.description = description; 
                this.example = example;
                this.naming_convention = naming_convention; // eg. alt0 (affects how string is rendered)
            }
        }

        class Variable extends FormulaElement {
            constructor(div_name,
                        display_name, 
                        description, 
                        example, 
                        naming_conventions) {
                super(div_name, 
                    display_name, 
                    description, 
                    example, 
                    Object.keys(naming_conventions)[0]);
                this.naming_conventions = naming_conventions;
            }

            update_naming_convention(convention) {
                if (this.naming_conventions.hasOwnProperty(convention)) {
                    this.naming_convention = convention;
                }
                else {
                    console.log(`Naming convention ${convention} not found for ${this.div_name}`);
                }
            }

            str(delimiter="") {
                // Escaping the \ is necessary because this string will be passed into another string before being rendered
                return `${delimiter}\\class{${this.div_name}}{${this.naming_conventions[this.naming_convention]}}${delimiter}`;
            }
        }

        class Formula extends FormulaElement {
            constructor(div_name,
                        display_name, 
                        description, 
                        example, 
                        naming_convention, 
                        child_elements,
                        strFunction) {
                super(div_name,
                        display_name, 
                        description, 
                        example, 
                        naming_convention, 
                )
                this.child_elements = child_elements;
                this.strFunction = strFunction;
            }

            update_naming_convention(convention) {
                this.naming_convention = convention;
                for (const child of Object.values(this.child_elements)) {
                    child.update_naming_convention(convention);
                }
            }

            str(delimiter="") {
                return delimiter + this.strFunction(this.child_elements) + delimiter;
            }
        }

        const variables = {
            state: new Variable("state", 
                "State",
                "The state of the system", 
                "The position and velocity of a moving object", 
                {'alt0': `\\mathbf{x}`, 'alt1': `\\mathbf{s}`}
            ),
            state_transition: new Variable("state-transition-matrix", 
                "State Transition Matrix", 
                "The matrix that transforms the state estimate to the next state", 
                "Velocity matrix",
                {'alt0': "\\mathbf{F}", 'alt1': "\\mathbf{A}"}
            ),
            state_covariance: new Variable("state-covariance", 
                "State Covariance", 
                "The covariance of the state estimate", 
                "The uncertainty in the state estimate",
                {'alt0': "\\mathbf{P}"}
            ),
        }

        // All of the formulas that should be wrapped in $$ and typeset
        const formulas = {
            state_model: new Formula("state-model", 
                "State Model",
                "The state model of the system", 
                "The position and velocity of a moving object", 
                "alt0",
                variables, 
                (v) => `${v.state.str()}_t = ${v.state_transition.str()} ${v.state.str()}_{t-1}`)
         }

        function set_naming_convention(convention) {
            let elements_to_typeset = [];
            for (const object of [...Object.values(formulas), ...Object.values(variables)]) {
                const formulaDiv = document.getElementById(object.div_name);
                object.update_naming_convention(convention);
                formulaDiv.innerHTML = object.str("$$");
                elements_to_typeset.push(formulaDiv);
            }
            return elements_to_typeset;
        }

        // safe version of MathJax.typesetPromise that doesn't throw an error when MathJax is not yet loaded and logs errors
        function safeTypesetPromise(elements_to_typeset) {
            MathJax.startup.promise = MathJax.startup.promise
                .then(() => {
                    MathJax.typesetPromise(elements_to_typeset);
                    console.log("MathJax Typeset success");
                })
                .catch((err) => console.log('MathJax typeset() failed: ' + err.message));
            return MathJax.startup.promise;
        }

        // set all of the non-formula text descriptions
        function set_text_descriptions() {
            for (const object of [...Object.values(formulas), ...Object.values(variables)]) {
                display_div = document.getElementById(`${object.div_name}-name`);
                if (display_div) {
                    display_div.textContent = object.display_name;
                }

                description_div = document.getElementById(`${object.div_name}-description`);
                if (description_div) {
                    description_div.textContent = object.description;
                }

                example_div = document.getElementById(`${object.div_name}-example`);
                if (example_div) {
                    example_div.textContent = object.example;
                }
            }
        }

        set_naming_convention('alt0');
        set_text_descriptions();
        // calling the typeset function here fails because MathJax is not defined yet. 
        // It's ok to not call it because by default, MathJax waits for the HTML to load 
        // (including the set_naming_convention() function which fills in all the divs)
        // and then typesets the entire page.
        // safeTypesetPromise();

        document.getElementById('naming-convention').addEventListener('change', function(event) {
            const convention = event.target.value;
            elements_to_typeset = set_naming_convention(convention);
            safeTypesetPromise(elements_to_typeset);
        });

    </script>
</body>
</html>